<div class="modern-character-container">
  <div class="header-section">
    <div class="header-content">
      <h1 class="page-title">
        <span class="maple-icon">🍁</span>
        Character Arsenal
      </h1>
      <p class="page-subtitle">Manage your MapleStory characters and equipment</p>
    </div>
    <button class="add-character-btn" (click)="showAddCharacterForm = true">
      <span class="btn-icon">✨</span>
      Add Character
    </button>
  </div>

  <!-- Main Character Highlight -->
  <div *ngIf="getMainCharacter()" class="main-character-spotlight">
    <div class="spotlight-header">
      <span class="crown-icon">👑</span>
      <h2>Main Character</h2>
    </div>
    <div class="main-char-card">
      <div class="main-char-avatar">
        <img *ngIf="getMainCharacter()?.imageUrl" 
             [src]="getMainCharacter()?.imageUrl" 
             [alt]="getMainCharacter()?.name"
             class="main-char-image">
        <div *ngIf="!getMainCharacter()?.imageUrl" class="main-char-placeholder">
          {{ getMainCharacter()?.name?.charAt(0)?.toUpperCase() || '?' }}
        </div>
      </div>
      <div class="main-char-info">
        <h3 class="main-char-name">{{ getMainCharacter()?.name }}</h3>
        <div class="main-char-details">
          <span class="main-char-class">{{ getMainCharacter()?.class }}</span>
          <span class="main-char-level" *ngIf="getMainCharacter()?.level">
            Level {{ getMainCharacter()?.level }}
          </span>
          <span class="main-char-exp" *ngIf="getMainCharacter()?.expPercentage">
            {{ getMainCharacter()?.expPercentage }}
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Character Grid -->
  <div class="modern-characters-grid" cdkDropList (cdkDropListDropped)="drop($event)">
    <div *ngFor="let character of characters; let i = index" 
         cdkDrag 
         class="character-card-modern"
         [class.main-character]="character.isMain"
         [class.expanded]="character.isExpanded">
      
      <!-- Character Card Header -->
      <div class="card-header">
        <div class="character-avatar-section">
          <div class="avatar-container">
            <img *ngIf="character.imageUrl && !character.isLoading" 
                 [src]="character.imageUrl" 
                 [alt]="character.name" 
                 class="character-image-modern">
            
            <div *ngIf="character.isLoading" class="loading-spinner-modern"></div>
            
            <div *ngIf="!character.imageUrl && !character.isLoading" 
                 class="avatar-placeholder-modern">
              {{ character.name.charAt(0).toUpperCase() }}
            </div>

            <!-- Main Character Crown -->
            <div *ngIf="character.isMain" class="main-crown">👑</div>
          </div>
          
          <div class="character-info-section">
            <h3 class="character-name-modern">{{ character.name }}</h3>
            <div class="character-meta">
              <span class="character-class-modern">{{ character.class }}</span>
              <div class="level-exp-container" *ngIf="character.level">
                <span class="level-modern">Lv. {{ character.level }}</span>
                <span class="exp-modern" *ngIf="character.expPercentage">{{ character.expPercentage }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Card Actions -->
        <div class="card-actions">
          <button class="action-btn main-btn" 
                  (click)="setMainCharacter(i)" 
                  [class.active]="character.isMain"
                  title="Set as Main Character">
            <span class="btn-icon">👑</span>
          </button>
          
          <button class="action-btn equipment-btn" 
                  (click)="openEquipmentModal(i)"
                  title="Manage Equipment">
            <span class="btn-icon">⚔️</span>
          </button>
          
          <button class="action-btn refresh-btn" 
                  (click)="updateCharacterExperience(i)"
                  title="Update Experience">
            <span class="btn-icon">🔄</span>
          </button>
          
          <button class="action-btn expand-btn" 
                  (click)="toggleExpand(i)" 
                  title="Show/Hide Details">
            <span class="btn-icon">{{ character.isExpanded ? '⬆️' : '⬇️' }}</span>
          </button>
          
          <button class="action-btn delete-btn" 
                  (click)="confirmDeleteCharacter(i)" 
                  title="Delete Character">
            <span class="btn-icon">🗑️</span>
          </button>
        </div>
      </div>

      <!-- Expanded Content -->
      <div *ngIf="character.isExpanded" class="expanded-content">
        <div class="stats-and-equipment">
          <!-- Experience History Chart -->
          <div class="exp-history-section">
            <h4>📈 Experience Progress</h4>
            <div class="exp-chart" *ngIf="character.expHistory && character.expHistory.length > 0">
              <div class="chart-bars">
                <div *ngFor="let entry of character.expHistory.slice(0, 7)" 
                     class="exp-bar"
                     [style.height.%]="(entry.gained / getMaxExpGain(character)) * 100"
                     [title]="entry.date + ': +' + entry.gained.toLocaleString() + ' EXP'">
                  <span class="exp-value">{{ formatExpValue(entry.gained) }}</span>
                </div>
              </div>
              <div class="chart-labels">
                <span *ngFor="let entry of character.expHistory.slice(0, 7)" class="date-label">
                  {{ formatDate(entry.date) }}
                </span>
              </div>
            </div>
            <div *ngIf="!character.expHistory || character.expHistory.length === 0" class="no-data">
              No experience data yet. Click the refresh button to start tracking!
            </div>
          </div>

          <!-- Equipment Grid -->
          <div class="modern-equipment-section">
            <h4>⚔️ Equipment Setup</h4>
            <div class="equipment-grid-modern">
              <!-- Top Row -->
              <div class="equipment-row">
                <div class="equipment-slot-modern" data-slot="helmet" title="Helmet">
                  <span class="slot-icon">⛑️</span>
                  <div *ngIf="character.equipment?.helmet" class="equipped-item">
                    {{ character.equipment?.helmet?.name }}
                  </div>
                </div>
                <div class="equipment-slot-modern" data-slot="pendant" title="Pendant">
                  <span class="slot-icon">📿</span>
                  <div *ngIf="character.equipment?.pendant" class="equipped-item">
                    {{ character.equipment?.pendant?.name }}
                  </div>
                </div>
              </div>

              <!-- Middle Row -->
              <div class="equipment-row">
                <div class="equipment-slot-modern" data-slot="weapon" title="Weapon">
                  <span class="slot-icon">⚔️</span>
                  <div *ngIf="character.equipment?.weapon" class="equipped-item">
                    {{ character.equipment?.weapon?.name }}
                  </div>
                </div>
                <div class="equipment-slot-modern" data-slot="top" title="Top">
                  <span class="slot-icon">👕</span>
                  <div *ngIf="character.equipment?.top" class="equipped-item">
                    {{ character.equipment?.top?.name }}
                  </div>
                </div>
                <div class="equipment-slot-modern" data-slot="secondary" title="Secondary">
                  <span class="slot-icon">🛡️</span>
                  <div *ngIf="character.equipment?.secondary" class="equipped-item">
                    {{ character.equipment?.secondary?.name }}
                  </div>
                </div>
              </div>

              <!-- Bottom Row -->
              <div class="equipment-row">
                <div class="equipment-slot-modern" data-slot="gloves" title="Gloves">
                  <span class="slot-icon">🧤</span>
                  <div *ngIf="character.equipment?.gloves" class="equipped-item">
                    {{ character.equipment?.gloves?.name }}
                  </div>
                </div>
                <div class="equipment-slot-modern" data-slot="bottom" title="Bottom">
                  <span class="slot-icon">👖</span>
                  <div *ngIf="character.equipment?.bottom" class="equipped-item">
                    {{ character.equipment?.bottom?.name }}
                  </div>
                </div>
                <div class="equipment-slot-modern" data-slot="shoes" title="Shoes">
                  <span class="slot-icon">👟</span>
                  <div *ngIf="character.equipment?.shoes" class="equipped-item">
                    {{ character.equipment?.shoes?.name }}
                  </div>
                </div>
              </div>

              <!-- Rings Row -->
              <div class="rings-row">
                <div class="equipment-slot-modern ring-slot" data-slot="ring1" title="Ring 1">
                  <span class="slot-icon">💍</span>
                  <div *ngIf="character.equipment?.ring1" class="equipped-item">
                    {{ character.equipment?.ring1?.name }}
                  </div>
                </div>
                <div class="equipment-slot-modern ring-slot" data-slot="ring2" title="Ring 2">
                  <span class="slot-icon">💍</span>
                  <div *ngIf="character.equipment?.ring2" class="equipped-item">
                    {{ character.equipment?.ring2?.name }}
                  </div>
                </div>
                <div class="equipment-slot-modern ring-slot" data-slot="ring3" title="Ring 3">
                  <span class="slot-icon">💍</span>
                  <div *ngIf="character.equipment?.ring3" class="equipped-item">
                    {{ character.equipment?.ring3?.name }}
                  </div>
                </div>
                <div class="equipment-slot-modern ring-slot" data-slot="ring4" title="Ring 4">
                  <span class="slot-icon">💍</span>
                  <div *ngIf="character.equipment?.ring4" class="equipped-item">
                    {{ character.equipment?.ring4?.name }}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="add-character-card" (click)="showAddCharacterForm = !showAddCharacterForm">
      <div class="add-icon">+</div>
      <p>Add New Character</p>
    </div>
  </div>
  
  <div class="add-character-form" [class.active]="showAddCharacterForm">
    <div class="form-card">
      <h3>Add New Character</h3>
      <form (ngSubmit)="addCharacter()" #characterForm="ngForm">
        <div class="form-group">
          <label for="characterName">Character Name</label>
          <input 
            type="text" 
            id="characterName" 
            [(ngModel)]="newCharacter.name" 
            name="characterName" 
            required>
        </div>
        
        <div class="form-group">
          <label for="characterClass">Class</label>
          <div class="class-search-container">
            <input 
              type="text" 
              id="characterClass" 
              [(ngModel)]="classSearchTerm"
              (input)="onClassSearchInput()"
              (focus)="onClassInputFocus()"
              (blur)="onClassInputBlur()"
              name="characterClass" 
              placeholder="Type to search classes..."
              required>
            <input type="hidden" [(ngModel)]="newCharacter.class" name="selectedClass" required>
            
            <div class="class-dropdown" *ngIf="showClassDropdown">
              <div class="search-info" *ngIf="classSearchTerm">
                {{ filteredClasses.length }} class(es) found
              </div>
              <div 
                class="class-option" 
                *ngFor="let className of filteredClasses"
                (mousedown)="selectClass(className)">
                {{ className }}
              </div>
              <div class="no-results" *ngIf="classSearchTerm && filteredClasses.length === 0">
                No classes found matching "{{ classSearchTerm }}"
              </div>
            </div>
            
            <div class="selected-class" *ngIf="newCharacter.class && !showClassDropdown">
              Selected: <span class="class-name">{{ newCharacter.class }}</span>
            </div>
          </div>
        </div>
        
        <div class="form-actions">
          <button type="button" class="btn-cancel" (click)="cancelAdd()">Cancel</button>
          <button type="submit" class="btn-submit" [disabled]="!characterForm.form.valid">Add Character</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Confirmation Dialog -->
  <div class="delete-confirmation-overlay" *ngIf="showDeleteConfirmation" (click)="cancelDelete()">
    <div class="delete-confirmation-dialog" (click)="$event.stopPropagation()">
      <h3>Are you sure?</h3>
      <p>This will permanently delete the character.</p>
      <div class="dialog-actions">
        <button class="btn-cancel" (click)="cancelDelete()">Back</button>
        <button class="btn-delete" (click)="deleteCharacter()">Delete</button>
      </div>
    </div>
  </div>
